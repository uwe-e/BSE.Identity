@page "/"
@using BSE.Identity.Blazor.Client.Data;
@using BSE.Identity.Blazor.Client.Models;
@using BSE.Identity.Blazor.Client.Pages.Shared
@using BSE.Identity.Blazor.Client.Threading;
@using BSE.Identity.Blazor.Client.ViewModels;
@using Microsoft.Fast.Components.FluentUI
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject IStringLocalizer<Index> Localize
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ApplicationDbContext _context;

<FluentDialogProvider />

<PageTitle>@Localize["Txt_PageTitle"]</PageTitle>

<NavigationBar />

<FluentToolbar Style="width: 100%; border: 1px solid var(--accent-fill-rest)">
    <FluentLabel Typo="@Typography.PageTitle">@Localize["Txt_PageHeader"]</FluentLabel>
    <FluentButton slot="end" Appearance="Appearance.Accent" OnClick="@OnCreateUser">
        <FluentIcon Slot="start" Value="@(new Icons.Regular.Size16.PeopleAdd())" Color="Color.Fill" />
        @Localize["Btn_NewUser"]
    </FluentButton>
</FluentToolbar>


<FluentLabel Typo="@Typography.Header" Style="margin-top: 20px">@Localize["Txt_GridHeader"]</FluentLabel>

<ProgressOverlayPanel Style="height:500px; margin-top: 20px;" Visible="Users is null">

    <FluentDataGrid id="manualGrid" Items="@Users" Virtualize="true" ItemSize="40" role="grid" TGridItem="UserRolesViewModel">
        <PropertyColumn Property="@(u => u.UserName)" Title="@Localize["Grid_Column_UserName"]" Sortable="true" />
        <PropertyColumn Property="@(u => u.FirstName)" Title="@Localize["Grid_Column_FirstName"]" Sortable="true" />
        <PropertyColumn Property="@(u => u.LastName)" Title="@Localize["Grid_Column_LastName"]" Sortable="true" />
        <PropertyColumn Property="@(u => string.Join(", ", u.Roles123.Select(r => r.Name)))" Title="@Localize["Grid_Column_Roles"]" Sortable="true" />
        <TemplateColumn Title="Actions" Align="@Align.End">
            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => OnEditUser(context))">
                <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" Style="fill: var(--foreground-on-accent-rest)" />
            </FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => OnDeleteUser(context))">
                <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Style="fill: var(--foreground-on-accent-rest)" />
            </FluentButton>
        </TemplateColumn>
    </FluentDataGrid>

</ProgressOverlayPanel>

@code {
    IQueryable<UserRolesViewModel>? Users;
    bool IsBusy;

    protected override async Task OnInitializedAsync()
    {
        //IsBusy = true;
        Users = await GetApplicationUsersAsync();
        //IsBusy = false;
        await base.OnInitializedAsync();
    }

    async Task OnCreateUser()
    {
        var dialog = await DialogService.ShowDialogAsync<CreateUser>(new DialogParameters()
            {
                OnDialogResult = DialogService.CreateDialogCallback(this, OnUserCreated),
                Modal = true,
                PreventDismissOnOverlayClick = true,
            });
    }

    async Task OnEditUser(UserRolesViewModel model)
    {
        var dialog = await DialogService.ShowDialogAsync<EditUser>(model, new DialogParameters()
            {
                OnDialogResult = DialogService.CreateDialogCallback(this, OnUserCreated),
                Modal = true,
                PreventDismissOnOverlayClick = true
            });
    }

    async Task OnUserCreated(DialogResult result)
    {
        if (!result.Cancelled)
        {
            //IsBusy = true;
            Users = null;
            Users = await GetApplicationUsersAsync();
            //IsBusy = false;
        }
        await Task.CompletedTask;
    }

    async Task OnDeleteUser(UserRolesViewModel model)
    {
        string dialogResultYes = Localize.GetString("Dlg_Result_Yes");
        string dialogResultNo = Localize.GetString("Dlg_Result_No");
        string dialogTitle = Localize.GetString("Dlg_UserDeletion_Title");
        string dialogMessage = Localize.GetString("Dlg_UserDeletion_Message", model.UserName);

        var dialog = await DialogService.ShowConfirmationAsync(dialogMessage, dialogResultYes, dialogResultNo, dialogTitle);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            var userToDelete = _context.Users.First<ApplicationUser>(u => u.Id == model.UserId);
            if (userToDelete != null)
            {
                var userId = userToDelete.Id;
                var deletionResult = await UserManager.DeleteAsync(userToDelete);
                if (deletionResult.Succeeded)
                {
                    //IsBusy = true;
                    Users = null;
                    Users = await GetApplicationUsersAsync();
                    //IsBusy = false;
                }
            }
        }
    }

    private async Task<IQueryable<UserRolesViewModel>> GetApplicationUsersAsync()
    {
        return await Task.Run(GetApplicationUsers);
    }

    private IQueryable<UserRolesViewModel> GetApplicationUsers()
    {
        /*
        * this is because of that MySQL behaviour
        * https://mysqlconnector.net/troubleshooting/connection-reuse/
        *
        * the original query should be the use of UserManager.GetRolesAsync(user)
        */
        var usersWithRoles = UserManager.Users.GroupJoin(
            _context.UserRoles,
            user => user.Id,
            userrole => userrole.UserId,
            (user, userroles) => new UserRolesViewModel
                {
                    UserId = user.Id,
                    UserName = user.UserName,
                    Email = user.Email,
                    FirstName = user.FirstName,
                    LastName = user.LastName,
                    Roles123 = userroles.Select(ur => new RoleViewModel
                    {
                        Id = ur.RoleId,
                        IsSelected = true,
                        Name = _context.Roles
                    .Where(r => r.Id.Equals(ur.RoleId))
                    .Select(r => r.Name).First()
                    }).OrderBy(r => r.Name)
                }).OrderBy(u => u.Email).ToList<UserRolesViewModel>();

        return usersWithRoles.AsQueryable();
    }
}